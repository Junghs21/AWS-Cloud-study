# Chap04. AWS 부하분산 서비스
## Amazon ELB 기능 소개
### 부하분산이란

- 서버-클라이언트 환경에서 서버가 클라이언트 요청을 받아 처리하는 과정에서 발생하는 부하(연산 작업)에 대해 동일한 목적을 수행하는 다수의 서버에 분산 처리하는 기능

**부하 분산 사용 시 장점**

- 고가용성 및 내결함성이 향상되어 장애가 발생할 때 유연하게 대처 가능
- 서비스를 안정적으로 유지 가능

이런 부하분산을 **로드 밸런싱(load balancing)** 이라 하며, 부하분산을 수행하는 대상을 **로드 밸런서(load balancer)** 라고 한다.

> 💡 **고가용성**: 시스템이나 서비스가 지속적으로 작동 가능하도록 하는 기능  
**내결함성**: 시스템의 일부 구성 요소가 작동하지 않더라도 계속 작동할 수 있는 기능

### Amazon ELB 기능

- **Amazon ELB(Elastic Load Balancing)**
    - Amazon EC2 인스턴스에서 운영 중인 애플리케이션으로 마이크로서비스 또는 컨테이너 서비스로 유입되는 트래픽을 자동 분산 처리하는 기술
    - AWS의 오토 스케일링 기능과 결합해서 트래픽이 증가할 때 자동으로 인스턴스를 추가하거나 제거하면서 애플리케이션 가용성을 유지
    - 네트워크 및 응용 프로그램 수준의 로드 밸런싱을 지원하며 다양한 애플리케이션에 적용
    - SSL 암호화를 지원하여 애플리케이션의 보안을 강화

### Amazon ELB 구성 요소

- **로드 밸런서**
    - 여러 대의 EC2 인스턴스, IP 주소, 람다 등을 사용하여 트래픽을 대상 그룹에 있는 인스턴스로 분산시켜 애플리케이션의 가용성을 유지하는 역할
    - 사용자 요청을 받아 애플리케이션 서버로 전달하고, 애플리케이션 서버의 응답을 사용자에게 반환
- **대상 그룹**
    - 로드 밸런서에서 분산할 대상의 집합을 정의하는 구성 요소
    - 대상 그룹의 인스턴스에 대해 정적 또는 동적으로 구성 가능
    - 라우팅 규칙에 따라 요청을 받아들일 대상 그룹을 선택
- **리스너**
    - 로드 밸런서에서 사용할 포트와 프로토콜을 설정하는 구성 요소
    - 로드 밸런서에서 클라이언트 요청을 수신하고, 해당 요청을 처리할 대상 그룹을 선택하는 역할
    - 로드 밸런서에서 연결된 프로토콜과 포트를 사용하여 클라이언트 요청을 수신하고, 해당 요청을 대상 그룹으로 라우팅

![Amazon ELB 구성 요소][image1]

[image1]: https://user-images.githubusercontent.com/60495897/134759839-4ee32345-d41e-43ed-a3a2-dd0a81301f5e.png

### Amazon ELB 동작 방식
① **클라이언트 요청 수신** - 로드 밸런서에서 클라이언트 요청을 수신. 로드 밸런서는 클라이언트와 연결을 유지하며, 요청을 수신하려고 리스너를 등록  
② **대상 그룹 선택** - 수신한 클라이언트 요청을 처리할 대상 그룹을 선택. 대상 그룹은 인스턴스, IP 주소, 람다 함수, ALB 등 여러 유형의 대상으로 구성  
③ **트래픽 분산** - 선택된 대상 그룹에서 요청을 처리할 대상을 선택하고 해당 대상으로 요청을 분산. 이때 로드 밸런서는 각 대상의 가용성 상태를 모니터링하고 가용하지 않은 대상을 제외  
④ **응답 반환** - 분산된 요청을 대상에서 처리하고 클라이언트에 응답을 반환. 이때 응답은 로드 밸런서에서 수신한 것으로 반환되므로, 클라이언트는 로드 밸런서가 대상 그룹에서 선택한 대상에게서 마치 응답을 받는 것처럼 느껴질 수 있다.

- **ELB를 생성할 때 로드 밸런서와 통신하는 방식**

> 💡 **인터넷 경계 로드 밸런서**: 외부에서 직접 로드 밸런서에 접근하는 방식  
**내부 로드 밸런서**: 외부의 접근이 차단된 격리된 네트워크(내부 서버 전용)에서 로드 밸런서를 사용하는 방식


### Amazon ELB 교차 영역 로드 밸런싱
Amazon ELB는 여러 가용 영역에서 로드 밸런서 노드를 실행하며, 각 노드는 가용 영역 내 대상 그룹으로 요청을 분산한다. 이때 대상 그룹에 등록된 대상이 여러 가용 영역에 걸쳐 있다면 기본적으로 로드 밸런서는 동일한 비중으로 가용 영역 내에 있는 대상으로 트래픽을 분산한다.  
가용 영역 내 인스턴스 수량이 불균형할 때는 일부 인스턴스로 트래픽이 몰리고 다른 인스턴스는 **유휴 상태**가 되는 불균형 처리 문제가 발생할 수 있다.
- **유휴 상태**
    - 컴퓨터 시스템이 사용 가능한 상태이나 실제적인 작업이 없는 시간

불균형 로드 밸런싱을 해결하는데 Amazon ELB에서 제공하는 교차 영역 로드 밸런싱 기능을 사용할 수 있다.
- **ELB 교차 영역 로드 밸런싱(cross-zone load balancing)**
    - 여러 가용 영역에 걸쳐 있는 EC2 인스턴스나 컨테이너 등 대상을 더 효과적으로 로드 밸런싱하는 기능
    - 가용 영역별로 인스턴스 수량이 불균형하게 위치할 때 트래픽 비중 보정 가능
    - 트래픽을 분산하는 기준이 가용 영역이 아닌 대상 그룹에 속한 자원을 기준으로 균일한 비중의 로드 밸런싱을 수행

![교차 영역 로드 밸런싱 활성화/비활성화][image2]

[image2]: https://blog.kakaocdn.net/dn/W9eEc/btrElch8Wdb/OPaDT0G1Ojt7upYITYJXi0/img.png


### Amazon ELB 종류
- **CLB(Classic Load Balancer)**
    - Amazon ELB의 가장 초기에 출시된 로드 밸런서
    - 현재 레거시(legacy)서비스로 분류
- **ALB(Application Load Balancer)**
    - AWS에서 제공하는 L7 로드 밸런서
    - HTTP/HTTPS 같은 웹 애플리케이션 프로토콜을 지원
    - 대상 그룹 단위로 트래픽을 분산  
    **ALB 특징**
        - HTTP 헤더를 확인하여 다양한 라우팅 기능을 제공
            - **경로 기반 라우팅**: URL 경로를 기반으로 요청을 분산
            - **호스트 기반 라우팅**: 호스트 이름을 기반으로 요청을 분산
            - **쿼리 문자열 기반 라우팅**: URL 쿼리 문자열을 기반으로 요청을 분산
        - 오토 스케일링과 함께 사용하여 확장성 있는 애플리케이션을 구성
        - 대상 그룹 내 인스턴스에 대해 상태 검사를 수행하고, 문제가 발생하면 자동으로 장애 조치를 취함
        - Amazon CloudWatch Logs와 통합되어 로그 및 지표 데이터를 수집하고 모니터링 및 분석 가능
- **NLB(Network Load Balancer)**
    - AWS에서 제공하는 14 로드 밸런서
    - TCP·UDP·TLS 프로토콜을 지원
    - 클라이언트와 로드 밸런서 간 연결을 TCP레벨에서 유지하므로 대규모 트래픽 처리 가능
    - 대상 그룹의 대상이 IP 주소로 식별될 때 유용
    - 높은 처리량과 빠른 응답 시간을 보장하므로 게임 서버, VoIP 서비스, 미디어 스트리밍 등에서 사용  
    **NLB 특징**
        - **높은 처리량**
            - 초당 수백만 개의 연결을 처리 가능
        - **빠른 응답 시간**
            - 빠른 응답 시간을 위해 최적화된 L4 로드 밸런싱 알고리즘을 사용
        - **높은 가용성**
            - 여러 가용 영역에서 인스턴스를 실행하고 매우 빠른 인스턴스 검색을 수행하여 신속하게 장애를 복구
        - **IP 주소 보존**
            - 클라이언트 IP 주소를 원래 IP 주소로 보존 가능
            - 클라이언트 IP 주소를 유지하면서 로드 밸런싱을 수행 가능
        - **모니터링**
            - AWS CloudTrail, Amazon CloudWatch Logs 같은 모니터링 기능 제공
- **GWLB(GateWay Load Balancer)**
    - 네트워크 트래픽을 서드 파티 방화벽/어플라이언스 장비로 부하분산 처리하는 로드 밸런서
    - 서드 파티의 방화벽/어플라이언스 장비를 쉽게 배포하고 확장 및 관리
    - 요청에 따라 트래픽을 확장하거나 축소하면서 다수의 서드 파티 장비에 로드 밸런싱을 처리
    - VPC 내에서 실행되는 애플리케이션의 가용성과 확정성을 향상시키는데 사용



**ALB** vs **NLB**

> 💡 **ALB**: HTTP/HTTPS 처리에 특화된 애플리케이션 레벨의 로드 밸런서로, OSI 모델의 7계층에서 라우팅 동작이 가능. 람다(lambda)를 대상 그룹 지정할 수 있다.  
**NLB**: TCP, UDP, TLS에 대한 트래픽을 처리할 수 있는 OSI 4계층의 로드 밸런서, ELB 중 가장 빠르고 높은 처리량을 지원한다. 고정 IP를 사용할 수 있다.
